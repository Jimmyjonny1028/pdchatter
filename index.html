<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Toolkit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/+esm"></script>
    <style>
        body {
            font-family: Inter, sans-serif;
        }
        .chat-bubble {
            max-width: 90%;
            word-wrap: break-word;
            white-space: pre-wrap;
            margin-bottom: 0.5rem;
        }
        .user-bubble {
            background-color: #3b82f6;
            color: white;
            border-radius: 1rem 1rem 0.25rem 1rem;
        }
        .ai-bubble {
            background-color: #4b5563;
            color: #e5e7eb;
            border-radius: 1rem 1rem 1rem 0.25rem;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(17, 24, 39, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: #1f2937;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 400px;
            color: #d1d5db;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .modal-content input {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: white;
            padding: 0.5rem;
            border-radius: 0.3rem;
            margin-bottom: 1rem;
            width: 100%;
        }
        .modal-content input::placeholder {
            color: #9ca3af;
        }
        .modal-content button {
            background-color: #3b82f6;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.3rem;
            cursor: pointer;
            width: 100%;
        }
        .modal-content button:hover {
            background-color: #2563eb;
        }
        .hidden {
            display: none;
        }
        .active {
            background-color: #3b82f6;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">
    <!-- Login Modal -->
    <div id="authModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">AI Toolkit</h2>
            
            <div id="loginForm">
                <input id="loginUsername" type="text" placeholder="Username">
                <input id="loginPassword" type="password" placeholder="Password">
                <button onclick="handleAuthSubmit('login')">Login</button>
                <p class="text-center mt-4 text-sm">
                    Don't have an account? <button onclick="switchToSignup()" class="text-blue-400 underline">Sign up</button>
                </p>
            </div>
            
            <div id="signupForm" class="hidden">
                <input id="signupUsername" type="text" placeholder="Username">
                <input id="signupPassword" type="password" placeholder="Password">
                <input id="signupPasswordConfirm" type="password" placeholder="Confirm Password">
                <button onclick="handleAuthSubmit('signup')">Sign Up</button>
                <p class="text-center mt-4 text-sm">
                    Already have an account? <button onclick="switchToLogin()" class="text-blue-400 underline">Login</button>
                </p>
            </div>
            
            <p id="authError" class="text-red-400 text-sm mt-2"></p>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden flex h-screen">
        <!-- Sidebar -->
        <div id="sidebar" class="w-64 bg-gray-800 border-r border-gray-700 flex flex-col transition-transform duration-300">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h1 class="text-xl font-bold">AI Toolkit</h1>
                <button id="toggleSidebar" onclick="toggleSidebar()" class="lg:hidden text-gray-400 hover:text-gray-200">
                    âœ•
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4">
                <button onclick="newAIChat()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded mb-4">
                    + New Chat
                </button>
                <button onclick="newPDFChat()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded mb-4">
                    + New PDF Chat
                </button>
                
                <div id="chatList" class="space-y-2">
                    <!-- Chats will be loaded here -->
                </div>
            </div>
            
            <div class="p-4 border-t border-gray-700">
                <button id="authButton" onclick="handleLogout()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded">
                    Logout
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col">
            <!-- Header -->
            <div class="bg-gray-800 border-b border-gray-700 p-4 flex items-center justify-between">
                <button id="mobileSidebarToggle" onclick="toggleSidebar()" class="lg:hidden text-gray-400 hover:text-gray-200 text-2xl">
                    â˜°
                </button>
                <div id="statusBar" class="text-sm text-gray-400">Ready</div>
                <div></div>
            </div>

            <!-- Tabs -->
            <div class="bg-gray-800 border-b border-gray-700 flex">
                <button id="tabAIChat" class="flex-1 py-2 text-center border-b-2 border-blue-500 active" onclick="switchTab('aichat')">
                    AI Chat
                </button>
                <button id="tabChatPDF" class="flex-1 py-2 text-center border-b-2 border-transparent hover:border-gray-600" onclick="switchTab('pdfchat')">
                    PDF Chat
                </button>
            </div>

            <!-- Chat Views -->
            <div class="flex-1 flex overflow-hidden">
                <!-- AI Chat View -->
                <div id="viewAIChat" class="flex-1 flex flex-col">
                    <div id="aiChatContainer" class="flex-1 overflow-y-auto p-4 space-y-4">
                        <!-- Messages will be rendered here -->
                    </div>
                    
                    <div id="errorRetryContainerAi" class="hidden p-4 bg-red-900 border border-red-700 rounded mb-4">
                        <p id="errorMessageAi" class="text-red-200 mb-2"></p>
                        <button onclick="retryMessage('aichat')" class="bg-red-600 hover:bg-red-700 text-white py-1 px-3 rounded text-sm">
                            Retry
                        </button>
                    </div>
                    
                    <div class="p-4 border-t border-gray-700">
                        <div class="flex gap-2">
                            <input id="aiChatInput" type="text" placeholder="Type your message..." class="flex-1 bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white focus:outline-none" onkeypress="handleInputKeyPress(event, 'aichat')">
                            <button onclick="sendMessage('aichat')" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded">
                                Send
                            </button>
                        </div>
                    </div>
                </div>

                <!-- PDF Chat View -->
                <div id="viewChatPDF" class="hidden flex-1 grid grid-cols-2 gap-4">
                    <!-- PDF Viewer -->
                    <div class="flex flex-col">
                        <div class="bg-gray-800 border-b border-gray-700 p-4">
                            <h3 id="pdfTitle" class="font-bold">PDF Preview</h3>
                        </div>
                        <iframe id="pdfViewer" class="flex-1" src=""></iframe>
                        
                        <div class="p-4 border-t border-gray-700">
                            <input id="pdfUploadInput" type="file" accept=".pdf" class="text-sm text-gray-400" onchange="handlePDFUpload()">
                        </div>
                    </div>

                    <!-- PDF Chat -->
                    <div class="flex flex-col">
                        <div id="pdfChatContainer" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-850">
                            <!-- Messages will be rendered here -->
                        </div>
                        
                        <div id="errorRetryContainerPdf" class="hidden p-4 bg-red-900 border border-red-700 rounded mb-4">
                            <p id="errorMessagePdf" class="text-red-200 mb-2"></p>
                            <button onclick="retryMessage('pdfchat')" class="bg-red-600 hover:bg-red-700 text-white py-1 px-3 rounded text-sm">
                                Retry
                            </button>
                        </div>
                        
                        <div class="p-4 border-t border-gray-700">
                            <div class="flex gap-2">
                                <input id="pdfChatInput" type="text" placeholder="Ask about the PDF..." class="flex-1 bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white focus:outline-none" onkeypress="handleInputKeyPress(event, 'pdfchat')">
                                <button onclick="sendMessage('pdfchat')" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded">
                                    Send
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ CONFIGURATION ============
        const RENDER_API_BASE_URL = "https://chatpdf-server-shtq.onrender.com/";
        let socket = null;
        let guestId = `guest_${Math.random().toString(36).substring(7)}`;
        let activeTab = "aichat";
        let pingInterval = null;
        let streamingMessage = null;
        let currentPDFName = null;

        // Chat history
        let aiChatHistory = [];
        let pdfChatHistory = [];
        let currentAIChatId = null;
        let currentPdfChatId = null;

        // UI Elements
        const ui = {
            authModal: document.getElementById("authModal"),
            mainApp: document.getElementById("mainApp"),
            loginForm: document.getElementById("loginForm"),
            signupForm: document.getElementById("signupForm"),
            loginUsername: document.getElementById("loginUsername"),
            loginPassword: document.getElementById("loginPassword"),
            signupUsername: document.getElementById("signupUsername"),
            signupPassword: document.getElementById("signupPassword"),
            signupPasswordConfirm: document.getElementById("signupPasswordConfirm"),
            authError: document.getElementById("authError"),
            authButton: document.getElementById("authButton"),
            statusBar: document.getElementById("statusBar"),
            sidebar: document.getElementById("sidebar"),
            chatList: document.getElementById("chatList"),
            tabAIChat: document.getElementById("tabAIChat"),
            tabChatPDF: document.getElementById("tabChatPDF"),
            viewAIChat: document.getElementById("viewAIChat"),
            viewChatPDF: document.getElementById("viewChatPDF"),
            aiChatContainer: document.getElementById("aiChatContainer"),
            pdfChatContainer: document.getElementById("pdfChatContainer"),
            aiChatInput: document.getElementById("aiChatInput"),
            pdfChatInput: document.getElementById("pdfChatInput"),
            pdfTitle: document.getElementById("pdfTitle"),
            pdfViewer: document.getElementById("pdfViewer"),
            pdfUploadInput: document.getElementById("pdfUploadInput"),
            errorRetryContainerAi: document.getElementById("errorRetryContainerAi"),
            errorRetryContainerPdf: document.getElementById("errorRetryContainerPdf"),
            errorMessageAi: document.getElementById("errorMessageAi"),
            errorMessagePdf: document.getElementById("errorMessagePdf"),
        };

        // ============ INITIALIZATION ============
        window.addEventListener("load", () => {
            updateAuthUI();
            if (localStorage.getItem("aitoolkittoken")) {
                connectWebSocket();
            }
        });

        // ============ AUTH FUNCTIONS ============
        function switchToSignup() {
            ui.loginForm.classList.add("hidden");
            ui.signupForm.classList.remove("hidden");
            ui.authError.textContent = "";
        }

        function switchToLogin() {
            ui.signupForm.classList.add("hidden");
            ui.loginForm.classList.remove("hidden");
            ui.authError.textContent = "";
        }

        function updateAuthUI() {
            const token = localStorage.getItem("aitoolkittoken");
            if (token) {
                ui.authModal.classList.add("hidden");
                ui.mainApp.classList.remove("hidden");
                ui.authButton.textContent = "Logout";
                ui.authButton.onclick = handleLogout;
                loadSavedChats();
            } else {
                ui.authModal.classList.remove("hidden");
                ui.mainApp.classList.add("hidden");
                ui.authButton.textContent = "Login";
            }
        }

        async function handleAuthSubmit(type) {
            let username, password;

            if (type === "login") {
                username = ui.loginUsername.value;
                password = ui.loginPassword.value;
            } else {
                username = ui.signupUsername.value;
                password = ui.signupPassword.value;
                const confirm = ui.signupPasswordConfirm.value;
                if (password !== confirm) {
                    ui.authError.textContent = "Passwords don't match";
                    return;
                }
            }

            if (!username || !password) {
                ui.authError.textContent = "Please fill in all fields";
                return;
            }

            const endpoint = type === "login" ? "login" : "signup";
            try {
                const res = await fetch(RENDER_API_BASE_URL + endpoint, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, password }),
                });

                if (!res.ok) {
                    const err = await res.json();
                    ui.authError.textContent = err.detail || "Auth failed";
                    return;
                }

                const data = await res.json();
                
                // âœ… FIX: Handle both access_token and token fields
                const token = data.access_token || data.token;
                if (token) {
                    localStorage.setItem("aitoolkittoken", token);
                    console.log("âœ… Token stored:", token.substring(0, 20) + "...");
                    connectWebSocket();
                    updateAuthUI();
                } else {
                    ui.authError.textContent = "No token in response";
                }
            } catch (e) {
                ui.authError.textContent = `Error: ${e.message}`;
            }
        }

        function handleLogout() {
            localStorage.removeItem("aitoolkittoken");
            if (socket) socket.close();
            updateAuthUI();
            ui.loginUsername.value = "";
            ui.loginPassword.value = "";
        }

        // ============ WEBSOCKET ============
        function connectWebSocket() {
            const token = localStorage.getItem("aitoolkittoken");
            const wsUrl = token
                ? `${RENDER_API_BASE_URL.replace("http", "ws")}ws?token=${token}`
                : `${RENDER_API_BASE_URL.replace("http", "ws")}ws?guestid=${guestId}`;

            socket = new WebSocket(wsUrl);

            socket.onopen = () => {
                console.log("WebSocket connected");
                setUIState("workerready", "AI worker connected.");
                
                // âœ… FIX 1: Call updateAuthUI after WebSocket connects
                updateAuthUI();
                
                // Start pinging
                pingInterval = setInterval(() => {
                    if (socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify({ type: "ping" }));
                    }
                }, 25000);

                if (currentPDFName && activeTab === "pdfchat") {
                    setUIState("readytochat", `Ready: ${currentPDFName}`);
                }
                
                if (localStorage.getItem("aitoolkittoken")) {
                    setTimeout(() => loadSavedChats(), 100);
                }
            };

            socket.onmessage = (e) => {
                try {
                    const message = JSON.parse(e.data);
                    handleServerMessage(message);
                } catch (err) {
                    console.error("Failed to parse message:", err, e.data);
                }
            };

            socket.onerror = (e) => {
                console.error("WebSocket error:", e);
                setUIState("error", "Connection error");
            };

            socket.onclose = () => {
                console.log("WebSocket closed");
                clearInterval(pingInterval);
                setUIState("disconnected", "Disconnected from worker");
                if (localStorage.getItem("aitoolkittoken")) {
                    setTimeout(connectWebSocket, 3000);
                }
            };
        }

        // âœ… FIX 3: Add debug logging to handleServerMessage
        function handleServerMessage(message) {
            // Debug logging
            console.log("ðŸ“¨ Received message:", message.type, "target:", message.target, "data:", message.data?.substring?.(0, 100));

            const targetKey = message.target || activeTab;

            if (message.type === "pong") {
                return;
            }

            if (message.type === "auth_success") {
                console.log("âœ… Authentication successful, user_id:", message.user_id);
                setUIState("authed", "Authenticated");
                return;
            }

            if (message.type === "chunk") {
                if (!streamingMessage) {
                    streamingMessage = { type: "ai", text: "" };
                    addMessage("", "ai", targetKey);
                }
                streamingMessage.text += message.data;
                updateLastMessage(streamingMessage.text, targetKey);
            } else if (message.type === "end") {
                if (streamingMessage) {
                    const history = targetKey === "aichat" ? aiChatHistory : pdfChatHistory;
                    if (history.length > 0) {
                        history[history.length - 1].text = streamingMessage.text;
                    }
                    streamingMessage = null;
                }
                setUIState("workerready", "Ready");
            } else if (message.type === "error") {
                console.error("Server error:", message.data);
                setUIState("error", `Error: ${message.data}`);
                ui.errorRetryContainerAi.style.display = targetKey === "aichat" ? "block" : "none";
                ui.errorRetryContainerPdf.style.display = targetKey === "pdfchat" ? "block" : "none";
                if (targetKey === "aichat") {
                    ui.errorMessageAi.textContent = message.data;
                } else {
                    ui.errorMessagePdf.textContent = message.data;
                }
            }
        }

        // ============ UI STATE ============
        function setUIState(state, message) {
            ui.statusBar.textContent = message;
            console.log(`[${state}] ${message}`);
        }

        function toggleSidebar() {
            ui.sidebar.classList.toggle("-translate-x-full");
        }

        function switchTab(tab) {
            activeTab = tab;
            if (tab === "aichat") {
                ui.viewAIChat.style.display = "flex";
                ui.viewChatPDF.style.display = "none";
                ui.tabAIChat.classList.add("active");
                ui.tabChatPDF.classList.remove("active");
            } else {
                ui.viewAIChat.style.display = "none";
                ui.viewChatPDF.style.display = "grid";
                ui.tabAIChat.classList.remove("active");
                ui.tabChatPDF.classList.add("active");
            }
        }

        // ============ CHAT FUNCTIONS ============
        function newAIChat() {
            currentAIChatId = `chat_${Date.now()}`;
            aiChatHistory = [];
            renderHistory(aiChatHistory, "aichat");
            switchTab("aichat");
            ui.aiChatInput.focus();
            ui.sidebar.classList.add("-translate-x-full");
        }

        function newPDFChat() {
            currentPdfChatId = `chat_${Date.now()}`;
            pdfChatHistory = [];
            renderHistory(pdfChatHistory, "pdfchat");
            switchTab("pdfchat");
            currentPDFName = null;
            ui.pdfTitle.textContent = "PDF Preview";
            ui.pdfViewer.src = "";
            ui.sidebar.classList.add("-translate-x-full");
        }

        // âœ… FIX 2: Fix loadChat to handle missing/null history
        function loadChat(chatData) {
            console.log("Loading chat:", chatData);
            cleanupStreaming();
            const currentChatIdKey = chatData.type === "aichat" ? "currentAIChatId" : "currentPdfChatId";
            sessionStorage.setItem(currentChatIdKey, chatData.id);
            activeTab = chatData.type;
            ui.errorRetryContainerPdf.style.display = "none";
            ui.errorRetryContainerAi.style.display = "none";

            // âœ… FIX: Ensure history is always an array
            const history = Array.isArray(chatData.history) ? chatData.history : [];

            if (chatData.type === "pdfchat") {
                ui.viewChatPDF.style.display = "grid";
                ui.viewAIChat.style.display = "none";
                ui.tabChatPDF.classList.add("active");
                ui.tabAIChat.classList.remove("active");
                pdfChatHistory = history;
                renderHistory(pdfChatHistory, "pdfchat");
                currentPDFName = chatData.pdfName || null;
                ui.pdfTitle.textContent = currentPDFName || "PDF Preview";
                ui.pdfViewer.src = "";
                if (!currentPDFName) {
                    addMessage("Chat loaded. Please re-upload the PDF to continue.", "system", "pdfchat");
                    setUIState("workerready", "Loaded chat. Re-upload PDF needed.");
                } else {
                    setUIState("workerready", "AI worker connected.");
                }
            } else {
                ui.viewChatPDF.style.display = "none";
                ui.viewAIChat.style.display = "flex";
                ui.tabChatPDF.classList.remove("active");
                ui.tabAIChat.classList.add("active");
                aiChatHistory = history;
                renderHistory(aiChatHistory, "aichat");
                setUIState("workerready", "AI worker connected.");
            }
            ui.sidebar.classList.add("-translate-x-full");
        }

        async function loadSavedChats() {
            try {
                const token = localStorage.getItem("aitoolkittoken");
                if (!token) return;

                const res = await fetch(RENDER_API_BASE_URL + "chats", {
                    headers: { "Authorization": `Bearer ${token}` },
                });

                if (!res.ok) throw new Error("Failed to load chats");

                const chats = await res.json();
                console.log("Loaded chats:", chats);

                ui.chatList.innerHTML = "";
                for (const chat of chats) {
                    const div = document.createElement("div");
                    div.className = "p-2 bg-gray-700 rounded cursor-pointer hover:bg-gray-600";
                    div.textContent = chat.name;
                    div.onclick = async () => {
                        const fullChat = await fetch(RENDER_API_BASE_URL + `chats/${chat.id}`, {
                            headers: { "Authorization": `Bearer ${token}` },
                        }).then(r => r.json());
                        loadChat(fullChat);
                    };
                    ui.chatList.appendChild(div);
                }
            } catch (e) {
                console.error("Error loading chats:", e);
            }
        }

        function renderHistory(history, type) {
            const container = type === "aichat" ? ui.aiChatContainer : ui.pdfChatContainer;
            container.innerHTML = "";
            for (const msg of history) {
                const div = document.createElement("div");
                div.className = `chat-bubble ${msg.type === "user" ? "user-bubble" : "ai-bubble"}`;
                if (msg.imageB64) {
                    const img = document.createElement("img");
                    img.src = `data:image/png;base64,${msg.imageB64}`;
                    img.className = "max-w-full rounded mb-2";
                    div.appendChild(img);
                }
                const text = document.createElement("div");
                text.innerHTML = marked.parse(msg.text || "");
                div.appendChild(text);
                container.appendChild(div);
            }
            container.scrollTop = container.scrollHeight;
        }

        function addMessage(text, type, targetType) {
            const container = targetType === "aichat" ? ui.aiChatContainer : ui.pdfChatContainer;
            const history = targetType === "aichat" ? aiChatHistory : pdfChatHistory;

            const msg = { type, text, imageB64: null };
            history.push(msg);

            const div = document.createElement("div");
            div.className = `chat-bubble ${type === "user" ? "user-bubble" : "ai-bubble"}`;
            const content = document.createElement("div");
            content.innerHTML = marked.parse(text || "");
            div.appendChild(content);
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;

            return div;
        }

        function updateLastMessage(text, targetType) {
            const container = targetType === "aichat" ? ui.aiChatContainer : ui.pdfChatContainer;
            const lastDiv = container.lastElementChild;
            if (lastDiv) {
                lastDiv.innerHTML = marked.parse(text);
            }
            container.scrollTop = container.scrollHeight;
        }

        function cleanupStreaming() {
            streamingMessage = null;
            ui.errorRetryContainerAi.style.display = "none";
            ui.errorRetryContainerPdf.style.display = "none";
        }

        function handleInputKeyPress(event, type) {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault();
                sendMessage(type);
            }
        }

        async function sendMessage(type) {
            const input = type === "aichat" ? ui.aiChatInput : ui.pdfChatInput;
            const text = input.value.trim();
            if (!text) return;

            input.value = "";
            addMessage(text, "user", type);
            cleanupStreaming();

            const msg = {
                type: "message",
                target: type,
                text,
                chat_id: type === "aichat" ? currentAIChatId : currentPdfChatId,
                pdf_name: currentPDFName,
            };

            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify(msg));
                setUIState("thinking", "Thinking...");
            }
        }

        async function retryMessage(type) {
            const history = type === "aichat" ? aiChatHistory : pdfChatHistory;
            if (history.length === 0) return;

            const lastMessage = history[history.length - 1];
            if (lastMessage.type !== "user") return;

            const msg = {
                type: "message",
                target: type,
                text: lastMessage.text,
                chat_id: type === "aichat" ? currentAIChatId : currentPdfChatId,
                pdf_name: currentPDFName,
            };

            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify(msg));
                setUIState("thinking", "Retrying...");
            }
        }

        async function handlePDFUpload() {
            const file = ui.pdfUploadInput.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64 = e.target.result.split(",")[1];
                const msg = {
                    type: "upload_pdf",
                    pdf_name: file.name,
                    pdf_data: base64,
                    chat_id: currentPdfChatId,
                };

                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify(msg));
                    currentPDFName = file.name;
                    ui.pdfTitle.textContent = file.name;
                    setUIState("uploading", "Uploading PDF...");
                }
            };
            reader.readAsDataURL(file);
        }
    </script>
</body>
</html>
