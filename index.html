<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Toolkit</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js for Markdown rendering (UMD format - global) -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.umd.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chat-bubble {
            max-width: 90%;
            word-wrap: break-word;
            white-space: pre-wrap;
            margin-bottom: 0.5rem;
        }
        .user-bubble {
            background-color: #3b82f6;
            color: white;
            border-radius: 1rem 1rem 0.25rem 1rem;
        }
        .ai-bubble {
            background-color: #4b5563;
            color: #e5e7eb;
            border-radius: 1rem 1rem 1rem 0.25rem;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(17, 24, 39, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: #1f2937;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 400px;
            color: #d1d5db;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .modal-content input {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: #e5e7eb;
            padding: 0.5rem;
            border-radius: 0.375rem;
            width: 100%;
            margin-top: 0.5rem;
        }
        .modal-content input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .thinking-bubble {
            background-color: #6366f1;
            color: white;
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .thinking-bubble:hover {
            background-color: #4f46e5;
        }
        .thinking-content {
            display: none;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        .thinking-content.visible {
            display: block;
        }
        code {
            background-color: #374151;
            color: #fbbf24;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-family: 'Courier New', monospace;
        }
        pre {
            background-color: #1f2937;
            border: 1px solid #4b5563;
            border-radius: 0.5rem;
            padding: 1rem;
            overflow-x: auto;
            margin: 0.5rem 0;
        }
        pre code {
            background-color: transparent;
            color: #e5e7eb;
            padding: 0;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-gray-800 flex flex-col border-r border-gray-700">
            <div class="p-4 border-b border-gray-700">
                <h1 class="text-xl font-bold">AI Toolkit</h1>
                <p id="status" class="text-sm text-gray-400 mt-2">Loading...</p>
            </div>
            <div class="flex-1 overflow-y-auto p-4">
                <div class="mb-4">
                    <button id="newChatBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition">
                        + New Chat
                    </button>
                </div>
                <div id="chatList" class="space-y-2">
                    <!-- Chat history will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col">
            <!-- Tab Navigation -->
            <div class="bg-gray-800 border-b border-gray-700 flex">
                <button id="aiChatTab" class="flex-1 px-4 py-3 text-center border-b-2 border-blue-500 bg-gray-700 text-white font-semibold transition">
                    AI Chat
                </button>
                <button id="pdfChatTab" class="flex-1 px-4 py-3 text-center border-b-2 border-gray-700 text-gray-400 hover:text-white transition">
                    PDF Chat
                </button>
            </div>

            <!-- Chat Area -->
            <div class="flex-1 overflow-y-auto p-6 bg-gray-900">
                <div id="chatArea" class="space-y-4">
                    <!-- Messages will be rendered here -->
                </div>
            </div>

            <!-- Input Area -->
            <div class="bg-gray-800 border-t border-gray-700 p-4">
                <div class="flex gap-2 mb-3">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="webSearchToggle" class="rounded">
                        <span class="text-sm">Web Search</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="instantAnswerToggle" class="rounded">
                        <span class="text-sm">Fast Paste</span>
                    </label>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="userInput" placeholder="Ask something..." class="flex-1 bg-gray-700 text-white px-4 py-2 rounded border border-gray-600 focus:border-blue-500 focus:outline-none">
                    <button id="sendBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded transition font-semibold">
                        Send
                    </button>
                    <button id="uploadPdfBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded transition font-semibold">
                        Upload PDF
                    </button>
                    <input type="file" id="pdfInput" accept=".pdf" style="display: none;">
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 class="text-lg font-bold mb-4">Upload PDF</h2>
            <input type="file" id="modalPdfInput" accept=".pdf" class="w-full px-3 py-2 bg-gray-700 text-white rounded border border-gray-600 focus:border-blue-500 focus:outline-none">
            <div class="mt-4 flex gap-2">
                <button id="confirmUploadBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition">
                    Upload
                </button>
                <button id="cancelUploadBtn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded transition">
                    Cancel
                </button>
            </div>
            <div id="uploadProgress" class="mt-4 hidden">
                <div class="w-full bg-gray-700 rounded-full h-2">
                    <div id="uploadProgressBar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                </div>
                <p id="uploadProgressText" class="text-sm mt-2 text-center">0%</p>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        const WS_URL = 'wss://chatpdf-server-shtq.onrender.com/ws/web';
        const API_BASE = 'https://chatpdf-server-shtq.onrender.com';
        const FETCH_INTERVAL = 2000;
        const STREAM_UPDATE_INTERVAL = 100;
        const MAX_RETRIES = 3;

        // ===== STATE =====
        let ws = null;
        let userId = null;
        let currentChatId = null;
        let activeTab = 'ai_chat';
        let fetchInterval = null;
        let renderInterval = null;
        let webSearchEnabled = false;
        let instantAnswerMode = false;

        const streamingState = {
            ai_chat: { ended: false, summary: null, content: '' },
            ai_thoughts: { ended: false, summary: null, content: '' },
            pdf_chat: { ended: false, summary: null, content: '' },
            pdf_thoughts: { ended: false, summary: null, content: '' }
        };

        // ===== DOM ELEMENTS =====
        const ui = {
            status: document.getElementById('status'),
            chatArea: document.getElementById('chatArea'),
            userInput: document.getElementById('userInput'),
            sendBtn: document.getElementById('sendBtn'),
            uploadPdfBtn: document.getElementById('uploadPdfBtn'),
            pdfInput: document.getElementById('pdfInput'),
            chatList: document.getElementById('chatList'),
            newChatBtn: document.getElementById('newChatBtn'),
            aiChatTab: document.getElementById('aiChatTab'),
            pdfChatTab: document.getElementById('pdfChatTab'),
            uploadModal: document.getElementById('uploadModal'),
            modalPdfInput: document.getElementById('modalPdfInput'),
            confirmUploadBtn: document.getElementById('confirmUploadBtn'),
            cancelUploadBtn: document.getElementById('cancelUploadBtn'),
            uploadProgress: document.getElementById('uploadProgress'),
            uploadProgressBar: document.getElementById('uploadProgressBar'),
            uploadProgressText: document.getElementById('uploadProgressText'),
            webSearchToggle: document.getElementById('webSearchToggle'),
            instantAnswerToggle: document.getElementById('instantAnswerToggle')
        };

        // ===== HELPER FUNCTIONS =====
        function log(msg) {
            console.log(`[${new Date().toLocaleTimeString()}] ${msg}`);
        }

        function updateStatus(msg) {
            ui.status.textContent = msg;
            log(msg);
        }

        function renderMarkdown(text) {
            try {
                return marked.parse(text);
            } catch (err) {
                console.error('Markdown parsing error', err);
                return `<p>${text.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>`;
            }
        }

        function renderCharacters(text) {
            try {
                const html = renderMarkdown(text);
                const div = document.createElement('div');
                div.innerHTML = html;
                return div;
            } catch (err) {
                console.error('Markdown parsing error', err);
                const div = document.createElement('div');
                div.textContent = text;
                return div;
            }
        }

        function createChatBubble(text, isUser, isThinking = false) {
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${isUser ? 'user-bubble' : 'ai-bubble'}`;
            if (isThinking) {
                bubble.className = 'thinking-bubble';
                bubble.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>ðŸ§  AI Thinking Process</span>
                        <span style="font-size: 0.8rem; opacity: 0.7;">Click to expand</span>
                    </div>
                    <div class="thinking-content" style="font-size: 0.9rem; opacity: 0.8;"></div>
                `;
                const contentDiv = bubble.querySelector('.thinking-content');
                bubble.addEventListener('click', () => {
                    contentDiv.classList.toggle('visible');
                });
                bubble.querySelector('.thinking-content').appendChild(renderCharacters(text));
                return bubble;
            }
            bubble.appendChild(renderCharacters(text));
            return bubble;
        }

        function removeThinkingBubble() {
            const bubble = ui.chatArea.querySelector('.thinking-bubble');
            if (bubble) {
                bubble.remove();
                log('Thinking bubble removed');
            }
        }

        // ===== STREAMING STATE MANAGEMENT =====
        function initializeStreamingState(target) {
            if (!streamingState[target]) {
                streamingState[target] = { ended: false, summary: null, content: '' };
            }
            streamingState[target].ended = false;
            streamingState[target].content = '';
        }

        // ===== WEBSOCKET MESSAGE HANDLER =====
        function handleServerMessage(message) {
            const { type, user_id, data, target } = message;
            const isThought = target && target.endsWith('thoughts');
            const targetKey = target || activeTab;

            switch (type) {
                case 'auth_success':
                case 'auth_fail':
                    log(`Authentication: ${type}`);
                    if (type === 'auth_success') {
                        userId = user_id;
                        updateStatus('Connected! Ready to chat.');
                        fetchChatHistory();
                    }
                    break;

                case 'answer_chunk':
                    if (!streamingState[targetKey]) {
                        initializeStreamingState(targetKey);
                    }
                    streamingState[targetKey].content += data;
                    break;

                case 'answer_end':
                    if (streamingState[targetKey]) {
                        streamingState[targetKey].ended = true;
                        if (isThought) {
                            const bubble = streamingState[targetKey].summary;
                            if (bubble) {
                                bubble.textContent = 'View Thinking Process (Finished)';
                            }
                        }

                        // CRITICAL FIX: Only clear thinking bubble when BOTH streams are done
                        console.log(`âœ“ Stream ended: ${targetKey}`);
                        console.log('Current state:', Object.entries(streamingState).map(([k, v]) => `${k}: ${v.ended}`).join(', '));

                        const mainChatKey = activeTab === 'ai_chat' ? 'ai_chat' : 'pdf_chat';
                        const thoughtsKey = activeTab === 'ai_chat' ? 'ai_thoughts' : 'pdf_thoughts';

                        const mainStreamDone = streamingState[mainChatKey]?.ended;
                        const thoughtsStreamDone = streamingState[thoughtsKey]?.ended;

                        console.log(`Main (${mainChatKey}): ${mainStreamDone}, Thoughts (${thoughtsKey}): ${thoughtsStreamDone}`);

                        if (mainStreamDone && thoughtsStreamDone) {
                            console.log('âœ“âœ“ Both streams complete! Clearing thinking bubble.');
                            removeThinkingBubble();
                        } else {
                            console.log('â³ Waiting for other stream...');
                        }
                    }
                    break;

                case 'error':
                    log(`Error: ${data}`);
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'chat-bubble ai-bubble';
                    errorDiv.style.color = '#ef4444';
                    errorDiv.textContent = `âš ï¸ Error: ${data}`;
                    ui.chatArea.appendChild(errorDiv);
                    break;

                case 'status':
                    updateStatus(data);
                    break;

                default:
                    log(`Unknown message type: ${type}`);
            }
        }

        // Render streaming content periodically
        function startRenderInterval() {
            if (renderInterval) clearInterval(renderInterval);
            renderInterval = setInterval(() => {
                Object.entries(streamingState).forEach(([targetKey, state]) => {
                    if (state.content && !state.summary) {
                        let bubble;
                        if (targetKey.endsWith('thoughts')) {
                            bubble = createChatBubble(state.content, false, true);
                        } else {
                            bubble = createChatBubble(state.content, false, false);
                        }
                        state.summary = bubble;
                        ui.chatArea.appendChild(bubble);
                        ui.chatArea.scrollTop = ui.chatArea.scrollHeight;
                    } else if (state.content && state.summary) {
                        const contentDiv = state.summary.querySelector('.thinking-content') || state.summary;
                        contentDiv.innerHTML = '';
                        contentDiv.appendChild(renderCharacters(state.content));
                        ui.chatArea.scrollTop = ui.chatArea.scrollHeight;
                    }
                });
            }, STREAM_UPDATE_INTERVAL);
        }

        function stopRenderInterval() {
            if (renderInterval) {
                clearInterval(renderInterval);
                renderInterval = null;
            }
        }

        // ===== WEBSOCKET CONNECTION =====
        function connectWebSocket() {
            updateStatus('Connecting...');
            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                log('WebSocket connected. Sending auth...');
                ws.send(JSON.stringify({ type: 'auth', token: localStorage.getItem('token') }));
            };

            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    console.log('WS Message Received', message);
                    handleServerMessage(message);
                } catch (err) {
                    log(`Error parsing message: ${err}`);
                }
            };

            ws.onerror = (err) => {
                log(`WebSocket error: ${err}`);
                updateStatus('Connection error. Reconnecting...');
            };

            ws.onclose = () => {
                log('WebSocket closed. Reconnecting in 3s...');
                updateStatus('Disconnected. Reconnecting...');
                setTimeout(connectWebSocket, 3000);
            };
        }

        // ===== CHAT FUNCTIONS =====
        async function fetchChatHistory() {
            try {
                const response = await fetch(`${API_BASE}/api/chats`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const chats = await response.json();
                console.log('Fetched chats from backend:', chats.length, 'Total in response:', chats.length);

                ui.chatList.innerHTML = '';
                chats.forEach(chat => {
                    if (!chat || !chat.id) return;
                    const chatItem = document.createElement('button');
                    chatItem.className = `w-full text-left px-3 py-2 rounded hover:bg-gray-700 transition text-sm truncate ${chat.id === currentChatId ? 'bg-blue-600' : ''}`;
                    chatItem.textContent = chat.title || 'Untitled Chat';
                    chatItem.onclick = () => selectChat(chat.id);
                    ui.chatList.appendChild(chatItem);
                });
            } catch (err) {
                log(`Error fetching chats: ${err}`);
            }
        }

        function selectChat(chatId) {
            currentChatId = chatId;
            ui.chatArea.innerHTML = '';
            Object.values(streamingState).forEach(state => state.ended = false);
            fetchChatHistory();
            updateStatus('Chat selected. Ready to ask questions.');
        }

        async function sendMessage() {
            const message = ui.userInput.value.trim();
            if (!message) return;

            ui.userInput.value = '';
            ui.sendBtn.disabled = true;

            // Add user message to chat
            const userBubble = createChatBubble(message, true);
            ui.chatArea.appendChild(userBubble);
            ui.chatArea.scrollTop = ui.chatArea.scrollHeight;

            // Reset streaming state
            Object.keys(streamingState).forEach(key => {
                streamingState[key].ended = false;
                streamingState[key].content = '';
                streamingState[key].summary = null;
            });

            // Show thinking bubble
            const thinkingBubble = createChatBubble('Thinking...', false, true);
            ui.chatArea.appendChild(thinkingBubble);

            startRenderInterval();

            // Send message
            if (ws && ws.readyState === WebSocket.OPEN) {
                const payload = {
                    type: activeTab === 'ai_chat' ? 'general_chat' : 'ask',
                    user_id: userId,
                    data: {
                        question: message,
                        history: [],
                        enable_web_search: webSearchEnabled,
                        instant_answer: instantAnswerMode
                    }
                };
                ws.send(JSON.stringify(payload));
            }

            ui.sendBtn.disabled = false;
        }

        // ===== PDF UPLOAD =====
        function uploadPdf(file) {
            if (!file) {
                updateStatus('No file selected');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const b64 = e.target.result.split(',')[1];
                ui.uploadProgress.classList.remove('hidden');

                const chunkSize = 50000;
                let uploaded = 0;

                // Send upload_start
                ws.send(JSON.stringify({
                    type: 'upload_start',
                    user_id: userId,
                    filename: file.name
                }));

                // Send chunks
                for (let i = 0; i < b64.length; i += chunkSize) {
                    const chunk = b64.slice(i, i + chunkSize);
                    ws.send(JSON.stringify({
                        type: 'upload_chunk',
                        user_id: userId,
                        data: chunk
                    }));
                    uploaded = Math.min(i + chunkSize, b64.length);
                    const percent = Math.round((uploaded / b64.length) * 100);
                    ui.uploadProgressBar.style.width = percent + '%';
                    ui.uploadProgressText.textContent = percent + '%';
                }

                // Send upload_end
                ws.send(JSON.stringify({
                    type: 'upload_end',
                    user_id: userId
                }));

                ui.uploadProgress.classList.add('hidden');
                updateStatus('PDF uploaded. Ready to ask questions.');
            };
            reader.readAsDataURL(file);
        }

        // ===== EVENT LISTENERS =====
        ui.sendBtn.addEventListener('click', sendMessage);
        ui.userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        ui.uploadPdfBtn.addEventListener('click', () => {
            ui.uploadModal.style.display = 'flex';
        });

        ui.confirmUploadBtn.addEventListener('click', () => {
            const file = ui.modalPdfInput.files[0];
            if (file) {
                uploadPdf(file);
                ui.uploadModal.style.display = 'none';
                ui.modalPdfInput.value = '';
            }
        });

        ui.cancelUploadBtn.addEventListener('click', () => {
            ui.uploadModal.style.display = 'none';
            ui.modalPdfInput.value = '';
        });

        ui.newChatBtn.addEventListener('click', () => {
            currentChatId = null;
            ui.chatArea.innerHTML = '';
            Object.values(streamingState).forEach(state => state.ended = false);
            updateStatus('New chat started.');
        });

        ui.aiChatTab.addEventListener('click', () => {
            activeTab = 'ai_chat';
            ui.aiChatTab.classList.add('border-blue-500', 'bg-gray-700');
            ui.aiChatTab.classList.remove('border-gray-700', 'text-gray-400');
            ui.pdfChatTab.classList.remove('border-blue-500', 'bg-gray-700');
            ui.pdfChatTab.classList.add('border-gray-700', 'text-gray-400');
            ui.chatArea.innerHTML = '';
            updateStatus('Switched to AI Chat');
        });

        ui.pdfChatTab.addEventListener('click', () => {
            activeTab = 'pdf_chat';
            ui.pdfChatTab.classList.add('border-blue-500', 'bg-gray-700');
            ui.pdfChatTab.classList.remove('border-gray-700', 'text-gray-400');
            ui.aiChatTab.classList.remove('border-blue-500', 'bg-gray-700');
            ui.aiChatTab.classList.add('border-gray-700', 'text-gray-400');
            ui.chatArea.innerHTML = '';
            updateStatus('Switched to PDF Chat');
        });

        ui.webSearchToggle.addEventListener('change', (e) => {
            webSearchEnabled = e.target.checked;
            log(`Web search ${webSearchEnabled ? 'enabled' : 'disabled'}`);
        });

        ui.instantAnswerToggle.addEventListener('change', (e) => {
            instantAnswerMode = e.target.checked;
            log(`Fast paste mode ${instantAnswerMode ? 'enabled' : 'disabled'}`);
        });

        // ===== INITIALIZATION =====
        connectWebSocket();
    </script>
</body>
</html>
